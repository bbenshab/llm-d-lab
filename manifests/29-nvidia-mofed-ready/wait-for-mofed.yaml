---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: mofed-readiness-checker
  namespace: nvidia-network-operator
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: mofed-readiness-checker
rules:
- apiGroups: ["apps"]
  resources: ["daemonsets"]
  verbs: ["get", "list"]
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list"]
- apiGroups: ["mellanox.com"]
  resources: ["nicclusterpolicies"]
  verbs: ["get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: mofed-readiness-checker
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: mofed-readiness-checker
subjects:
- kind: ServiceAccount
  name: mofed-readiness-checker
  namespace: nvidia-network-operator
---
apiVersion: batch/v1
kind: Job
metadata:
  name: wait-for-mofed-ready
  namespace: nvidia-network-operator
spec:
  backoffLimit: 20
  ttlSecondsAfterFinished: 60
  template:
    spec:
      serviceAccountName: mofed-readiness-checker
      restartPolicy: OnFailure
      containers:
      - name: wait-for-mofed
        image: registry.redhat.io/openshift4/ose-cli:latest
        command:
        - /bin/bash
        - -c
        - |
          set -e

          echo "Waiting for NicClusterPolicy to exist..."
          timeout=300
          while [ $timeout -gt 0 ]; do
            if oc get nicclusterpolicy nic-cluster-policy &>/dev/null; then
              echo "NicClusterPolicy found"
              break
            fi
            echo "Waiting for NicClusterPolicy... ($timeout seconds left)"
            sleep 5
            timeout=$((timeout - 5))
          done

          if [ $timeout -le 0 ]; then
            echo "ERROR: NicClusterPolicy not found after 5 minutes"
            exit 1
          fi

          echo "Waiting for MOFED DaemonSet to be created..."
          timeout=300
          while [ $timeout -gt 0 ]; do
            DS_NAME=$(oc get daemonsets -n nvidia-network-operator -l nvidia.com/ofed-driver -o name 2>/dev/null | head -1)
            if [ -n "$DS_NAME" ]; then
              echo "MOFED DaemonSet found: $DS_NAME"
              break
            fi
            echo "Waiting for MOFED DaemonSet... ($timeout seconds left)"
            sleep 5
            timeout=$((timeout - 5))
          done

          if [ -z "$DS_NAME" ]; then
            echo "ERROR: MOFED DaemonSet not found after 5 minutes"
            exit 1
          fi

          echo "Waiting for all MOFED pods to be Running and Ready..."
          oc wait --for=condition=Ready pods -n nvidia-network-operator -l nvidia.com/ofed-driver --timeout=1200s

          echo "MOFED drivers are ready! GPU Operator can now deploy."
          echo "Job will auto-cleanup in 60 seconds..."
          exit 0
