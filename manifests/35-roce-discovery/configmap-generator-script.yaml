apiVersion: v1
kind: ConfigMap
metadata:
  name: sriov-resource-generator-script
  namespace: openshift-sriov-network-operator
data:
  generate_resources.py: |
    import json
    import sys
    import os
    import glob

    discovery_dir = os.getenv('DISCOVERY_DIR', '/discovery')
    output_dir = os.getenv('OUTPUT_DIR', '/output')
    num_vfs = int(os.getenv('NUM_VFS', '8'))
    mtu = int(os.getenv('MTU', '9000'))
    ip_range_base = os.getenv('IP_RANGE_BASE', '10.0')
    network_namespace = os.getenv('NETWORK_NAMESPACE', 'default')
    route_dest = os.getenv('ROUTE_DEST', '192.168.75.0/24')
    subnet_mode = os.getenv('SUBNET_MODE', 'separate').lower()  # 'shared' or 'separate'

    print("\n=== Processing discovery files ===")

    # Collect all ports from all nodes
    all_ports = []
    node_count = 0

    for discovery_file in glob.glob(f"{discovery_dir}/*-ports.json"):
        node_name = os.path.basename(discovery_file).replace('-ports.json', '')
        node_count += 1

        print(f"Reading discovery from node: {node_name}")

        with open(discovery_file, 'r') as f:
            ports = json.load(f)

        for port in ports:
            if port.get('sriovCapable'):
                port['_node_name'] = node_name  # Track which node this came from
                all_ports.append(port)
                print(f"  Found: {port['pfName']} (device ID: {port['deviceID']})")

    print(f"\nTotal ports discovered: {len(all_ports)} across {node_count} nodes")

    # Deduplicate by (pfName, deviceID) - keep first occurrence
    unique_ports = {}
    for port in all_ports:
        key = (port['pfName'], port['deviceID'])
        if key not in unique_ports:
            unique_ports[key] = port

    print(f"Unique PF names (after deduplication): {len(unique_ports)}")

    # Generate resources for each unique PF
    print("\n=== Generating SR-IOV resources ===")

    port_index = 0
    for (pf_name, device_id), port in sorted(unique_ports.items()):
        resource_name = f"{pf_name}rdma"

        # Calculate IP range based on subnet mode
        if subnet_mode == 'shared':
            # All NICs share the same subnet (e.g., 10.0.100.0/24)
            ip_range = f"{ip_range_base}.100.0/24"
        else:
            # Each NIC gets its own unique subnet (e.g., 10.0.101.0/24, 10.0.102.0/24, etc.)
            subnet_third_octet = 101 + port_index
            ip_range = f"{ip_range_base}.{subnet_third_octet}.0/24"

        print(f"\nGenerating resources for PF: {pf_name}")
        print(f"  Device ID: {device_id}")
        print(f"  Resource Name: {resource_name}")
        print(f"  IP Range: {ip_range} (mode: {subnet_mode})")
        print(f"  Will apply to all nodes with this PF")

        # Generate SriovNetworkNodePolicy
        policy_yaml = f"""---
    apiVersion: sriovnetwork.openshift.io/v1
    kind: SriovNetworkNodePolicy
    metadata:
      name: policy-{pf_name}
      namespace: openshift-sriov-network-operator
    spec:
      deviceType: netdevice
      isRdma: true
      linkType: eth
      mtu: {mtu}
      nicSelector:
        deviceID: "{device_id}"
        pfNames:
          - {pf_name}
        vendor: "15b3"
      nodeSelector:
        feature.node.kubernetes.io/pci-15b3.present: "true"
        sriov-enabled: "true"
      numVfs: {num_vfs}
      priority: 99
      resourceName: {resource_name}
    """

        # Generate SriovNetwork
        network_yaml = f"""---
    apiVersion: sriovnetwork.openshift.io/v1
    kind: SriovNetwork
    metadata:
      name: {pf_name}-network
      namespace: openshift-sriov-network-operator
    spec:
      ipam: |
        {{
          "type": "whereabouts",
          "range": "{ip_range}",
          "routes": [
            {{
              "dst": "{route_dest}"
            }}
          ]
        }}
      linkState: enable
      networkNamespace: {network_namespace}
      resourceName: {resource_name}
      spoofChk: "off"
      trust: "on"
    """

        # Write policy
        policy_file = f"{output_dir}/policy-{pf_name}.yaml"
        with open(policy_file, 'w') as f:
            f.write(policy_yaml)
        print(f"  Created: {policy_file}")

        # Write network
        network_file = f"{output_dir}/network-{pf_name}.yaml"
        with open(network_file, 'w') as f:
            f.write(network_yaml)
        print(f"  Created: {network_file}")

        port_index += 1

    print(f"\nTotal networks created: {len(unique_ports)}")

  generate-sriov-resources.sh: |
    #!/bin/bash
    set -euo pipefail

    echo "=== SR-IOV Resource Generator ==="
    echo "Collecting discovery results from all nodes..."

    DISCOVERY_DIR="/discovery"
    OUTPUT_DIR="/output"
    mkdir -p "$DISCOVERY_DIR" "$OUTPUT_DIR"

    # Configuration
    NUM_VFS=${NUM_VFS:-8}
    MTU=${MTU:-9000}
    IP_RANGE_BASE=${IP_RANGE_BASE:-"10.0"}
    NETWORK_NAMESPACE=${NETWORK_NAMESPACE:-"default"}
    ROUTE_DEST=${ROUTE_DEST:-"192.168.75.0/24"}
    SUBNET_MODE=${SUBNET_MODE:-"separate"}  # "shared" or "separate"

    # Collect discovery results from all discovery pods
    echo "Finding RoCE discovery pods..."
    DISCOVERY_PODS=$(oc get pods -n openshift-sriov-network-operator -l app=roce-port-discovery -o jsonpath='{.items[*].metadata.name}')

    if [ -z "$DISCOVERY_PODS" ]; then
      echo "Error: No RoCE discovery pods found"
      exit 1
    fi

    echo "Found discovery pods: $DISCOVERY_PODS"

    # Collect discovery files from each pod
    for pod in $DISCOVERY_PODS; do
      echo "Collecting discovery results from pod: $pod"

      # Get the node name for this pod
      NODE_NAME=$(oc get pod "$pod" -n openshift-sriov-network-operator -o jsonpath='{.spec.nodeName}')
      echo "  Node: $NODE_NAME"

      # Copy the discovery file from the pod
      DISCOVERY_FILE="${DISCOVERY_DIR}/${NODE_NAME}-ports.json"
      if oc exec -n openshift-sriov-network-operator "$pod" -- cat /discovery/ports.json > "$DISCOVERY_FILE" 2>/dev/null; then
        echo "  ✓ Collected discovery file: $DISCOVERY_FILE"
      else
        echo "  ⚠ Failed to collect from $pod, trying node-specific file..."
        if oc exec -n openshift-sriov-network-operator "$pod" -- cat "/discovery/${NODE_NAME}-ports.json" > "$DISCOVERY_FILE" 2>/dev/null; then
          echo "  ✓ Collected discovery file: $DISCOVERY_FILE"
        else
          echo "  ✗ Failed to collect from $pod"
        fi
      fi
    done

    # Check if any discovery files exist
    if ! ls "$DISCOVERY_DIR"/*-ports.json 1> /dev/null 2>&1; then
      echo "Error: No discovery files were collected"
      exit 1
    fi

    echo ""
    echo "Found discovery files:"
    for file in "$DISCOVERY_DIR"/*-ports.json; do
      echo "  - $(basename "$file")"
    done

    # Run Python script to generate resources
    export DISCOVERY_DIR OUTPUT_DIR NUM_VFS MTU IP_RANGE_BASE NETWORK_NAMESPACE ROUTE_DEST SUBNET_MODE
    python3 /scripts/generate_resources.py

    echo ""
    echo "=== Applying generated SR-IOV resources to cluster ==="

    # Apply all generated resources
    APPLIED_COUNT=0
    for yaml_file in "$OUTPUT_DIR"/*.yaml; do
      if [ -f "$yaml_file" ]; then
        echo "Applying: $(basename "$yaml_file")"
        if oc apply -f "$yaml_file"; then
          APPLIED_COUNT=$((APPLIED_COUNT + 1))
        else
          echo "Warning: Failed to apply $(basename "$yaml_file")"
        fi
      fi
    done

    echo ""
    echo "=== Summary ==="
    echo "Total resources applied: $APPLIED_COUNT"
    echo "SR-IOV resource generation complete!"
